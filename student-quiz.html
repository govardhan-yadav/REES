<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Quiz Portal - REES</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px}
        .container{max-width:900px;margin:0 auto}
        h1{color:#333;margin-bottom:30px;text-align:center}
        .filters{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        .filters select{padding:10px;margin-right:10px;border:1px solid #ddd;border-radius:5px}
        .quiz-card{background:#fff;padding:20px;margin:15px 0;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);cursor:pointer;transition:transform 0.2s}
        .quiz-card:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,0.15)}
        .quiz-card h3{color:#667eea;margin-bottom:10px}
        .quiz-card p{color:#666;font-size:14px}
        .badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;margin-right:8px}
        .badge-easy{background:#d4edda;color:#155724}
        .badge-medium{background:#fff3cd;color:#856404}
        .badge-hard{background:#f8d7da;color:#721c24}
        .question-view{background:#fff;padding:30px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:none}
        .question{margin:30px 0;padding:20px;background:#f9f9f9;border-radius:8px}
        .option{padding:12px;margin:8px 0;background:#fff;border:2px solid #ddd;border-radius:5px;cursor:pointer}
        .option:hover{border-color:#667eea}
        .option.selected{border-color:#667eea;background:#e8eaf6}
        .option.correct{border-color:#27ae60;background:#d4edda}
        .option.wrong{border-color:#e74c3c;background:#f8d7da}
        .btn{padding:12px 30px;background:#667eea;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:16px}
        .btn:hover{background:#5568d3}
        .back-btn{background:#6c757d;margin-right:10px}
        .result{text-align:center;padding:30px;background:#e8eaf6;border-radius:10px;margin-top:20px}
        .result h2{color:#667eea;margin-bottom:10px}
        .new-badge{background:#fff;padding:20px;margin:20px 0;border-radius:10px;border:2px solid #ffd700;animation:badgeGlow 1s ease-in-out}
        .new-badge h3{color:#ffa500;margin-bottom:10px}
        .badge-icon{font-size:48px;margin:10px 0}
        @keyframes badgeGlow{0%,100%{box-shadow:0 0 10px rgba(255,215,0,0.5)}50%{box-shadow:0 0 20px rgba(255,215,0,0.8)}}
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Student Quiz Portal</h1>
        
        <!-- Learning Path Section -->
        <div id="learningPathSection" style="background:#fff;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:none">
            <h2 style="color:#667eea;margin-bottom:15px">üéØ Your Personalized Learning Path</h2>
            <div id="learningPathContent"></div>
        </div>
        
        <!-- Quiz List View -->
        <div id="quizListView">
            <div class="filters">
                <select id="filterClass" onchange="loadQuizzes()">
                    <option value="">All Classes</option>
                    <option value="Class 1">Class 1</option>
                    <option value="Class 2">Class 2</option>
                    <option value="Class 3">Class 3</option>
                    <option value="Class 4">Class 4</option>
                    <option value="Class 5">Class 5</option>
                    <option value="Class 6">Class 6</option>
                    <option value="Class 7">Class 7</option>
                    <option value="Class 8">Class 8</option>
                    <option value="Class 9">Class 9</option>
                    <option value="Class 10">Class 10</option>
                </select>
                <select id="filterSubject" onchange="loadQuizzes()">
                    <option value="">All Subjects</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="Science">Science</option>
                    <option value="English">English</option>
                    <option value="Social Studies">Social Studies</option>
                    <option value="Hindi">Hindi</option>
                </select>
            </div>
            <div id="quizList"></div>
        </div>
        
        <!-- Quiz Taking View -->
        <div id="quizView" class="question-view">
            <button class="btn back-btn" onclick="backToList()">‚Üê Back to Quizzes</button>
            <h2 id="quizTitle" style="margin:20px 0"></h2>
            <div id="questionsContainer"></div>
            <button class="btn" onclick="submitQuiz()" style="margin-top:20px">Submit Quiz</button>
            <div id="result"></div>
            <div id="newBadges"></div>
        </div>
    </div>

    <script>
        let currentQuiz = null;
        let userAnswers = {};
        let userId = localStorage.getItem('quiz_user_id');
        let previousBadges = [];
        let userClassLevel = 6; // Default class level
        
        // Generate anonymous user ID
        if(!userId){
            userId = 'u_'+Math.random().toString(36).slice(2);
            localStorage.setItem('quiz_user_id',userId);
        }
        
        // Load quizzes from API
        async function loadQuizzes(){
            const className = document.getElementById('filterClass').value;
            const subject = document.getElementById('filterSubject').value;
            
            let url = 'http://localhost:3001/api/quizzes?';
            if(className) url += 'className=' + encodeURIComponent(className) + '&';
            if(subject) url += 'subject=' + encodeURIComponent(subject);
            
            try{
                const r = await fetch(url);
                const d = await r.json();
                
                if(d.success){
                    displayQuizList(d.quizzes);
                }
            }catch(e){
                document.getElementById('quizList').innerHTML = '<p style="color:#e74c3c">Error loading quizzes. Make sure server is running.</p>';
                console.error(e);
            }
        }
        
        // Display quiz list
        function displayQuizList(quizzes){
            if(quizzes.length === 0){
                document.getElementById('quizList').innerHTML = '<p style="text-align:center;color:#999;padding:40px">No quizzes available. Teachers can create quizzes from the Teacher Dashboard.</p>';
                return;
            }
            
            const html = quizzes.map(quiz => `
                <div class="quiz-card" onclick="startQuiz('${quiz.id}')">
                    <h3>${quiz.className} - ${quiz.subject}</h3>
                    <p><strong>${quiz.chapter}</strong></p>
                    <p style="margin-top:10px">
                        <span class="badge badge-${quiz.difficulty}">${quiz.difficulty.toUpperCase()}</span>
                        <span style="color:#999">${quiz.questions.length} Questions</span>
                    </p>
                </div>
            `).join('');
            
            document.getElementById('quizList').innerHTML = html;
        }
        
        // Start a quiz
        async function startQuiz(quizId){
            try{
                const r = await fetch('http://localhost:3001/api/quizzes');
                const d = await r.json();
                
                if(d.success){
                    currentQuiz = d.quizzes.find(q => q.id === quizId);
                    if(currentQuiz){
                        userAnswers = {};
                        
                        // Load current badges before quiz
                        const badgeRes = await fetch(`http://localhost:3001/api/badges?userId=${userId}`);
                        const badgeData = await badgeRes.json();
                        previousBadges = badgeData.badges.filter(b=>b.earned).map(b=>b.code);
                        
                        displayQuiz();
                    }
                }
            }catch(e){
                alert('Error loading quiz');
                console.error(e);
            }
        }
        
        // Display quiz questions
        function displayQuiz(){
            document.getElementById('quizListView').style.display = 'none';
            document.getElementById('quizView').style.display = 'block';
            document.getElementById('result').innerHTML = '';
            document.getElementById('newBadges').innerHTML = '';
            
            document.getElementById('quizTitle').textContent = 
                `${currentQuiz.className} - ${currentQuiz.subject}: ${currentQuiz.chapter}`;
            
            const html = currentQuiz.questions.map((q, idx) => `
                <div class="question">
                    <h3 style="margin-bottom:15px">Question ${idx + 1}</h3>
                    <p style="font-size:18px;margin-bottom:15px">${q.q}</p>
                    ${q.options.map((opt, optIdx) => `
                        <div class="option" onclick="selectAnswer(${idx}, ${optIdx})" id="q${idx}_opt${optIdx}">
                            ${String.fromCharCode(65 + optIdx)}. ${opt}
                        </div>
                    `).join('')}
                </div>
            `).join('');
            
            document.getElementById('questionsContainer').innerHTML = html;
        }
        
        // Select an answer
        function selectAnswer(questionIdx, optionIdx){
            for(let i = 0; i < 4; i++){
                const el = document.getElementById(`q${questionIdx}_opt${i}`);
                if(el) el.classList.remove('selected');
            }
            
            document.getElementById(`q${questionIdx}_opt${optionIdx}`).classList.add('selected');
            userAnswers[questionIdx] = optionIdx;
        }
        
        // Submit quiz and show results
        async function submitQuiz(){
            if(Object.keys(userAnswers).length < currentQuiz.questions.length){
                if(!confirm('You haven\'t answered all questions. Submit anyway?')) return;
            }
            
            let correct = 0;
            
            currentQuiz.questions.forEach((q, idx) => {
                const userAnswer = userAnswers[idx];
                const correctAnswer = q.answerIndex;
                
                for(let i = 0; i < q.options.length; i++){
                    const el = document.getElementById(`q${idx}_opt${i}`);
                    if(!el) continue;
                    el.onclick = null;
                    el.classList.remove('selected');
                    
                    if(i === correctAnswer){
                        el.classList.add('correct');
                    } else if(i === userAnswer && userAnswer !== correctAnswer){
                        el.classList.add('wrong');
                    }
                }
                
                if(userAnswer === correctAnswer) correct++;
            });
            
            const percentage = Math.round((correct / currentQuiz.questions.length) * 100);
            
            // Save progress
            try{
                await fetch('http://localhost:3001/api/progress',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        userId,
                        className:currentQuiz.className,
                        subject:currentQuiz.subject,
                        chapter:currentQuiz.chapter,
                        score:percentage,
                        correct,
                        total:currentQuiz.questions.length,
                        quizId:currentQuiz.id
                    })
                });
                
                // Check for new badges
                const badgeRes = await fetch(`http://localhost:3001/api/badges?userId=${userId}`);
                const badgeData = await badgeRes.json();
                const currentBadges = badgeData.badges.filter(b=>b.earned).map(b=>b.code);
                const newBadges = badgeData.badges.filter(b=>b.earned && !previousBadges.includes(b.code));
                
                if(newBadges.length > 0){
                    const badgeHtml = newBadges.map(b=>`
                        <div class="new-badge">
                            <h3>üéâ New Badge Unlocked!</h3>
                            <div class="badge-icon">${b.icon}</div>
                            <h4>${b.label}</h4>
                            <p>${b.description}</p>
                        </div>
                    `).join('');
                    document.getElementById('newBadges').innerHTML = badgeHtml;
                }
                
                // Reload learning path after quiz completion
                loadLearningPath();
            }catch(e){
                console.error('Error saving progress:',e);
            }
            
            document.getElementById('result').innerHTML = `
                <div class="result">
                    <h2>Quiz Completed! üéâ</h2>
                    <p style="font-size:48px;margin:20px 0">${percentage}%</p>
                    <p style="font-size:18px">You got ${correct} out of ${currentQuiz.questions.length} questions correct</p>
                </div>
            `;
            
            document.getElementById('result').scrollIntoView({behavior: 'smooth'});
        }
        
        // Back to quiz list
        function backToList(){
            document.getElementById('quizListView').style.display = 'block';
            document.getElementById('quizView').style.display = 'none';
            currentQuiz = null;
            userAnswers = {};
        }
        
        // Load learning path
        async function loadLearningPath(){
            if(!userId) return;
            
            try{
                const r = await fetch(`http://localhost:3001/api/learning-path?userId=${userId}&classLevel=${userClassLevel}`);
                const data = await r.json();
                
                if(data.error){
                    console.error('Learning path error:',data.error);
                    return;
                }
                
                displayLearningPath(data);
            }catch(e){
                console.error('Error loading learning path:',e);
            }
        }
        
        // Display learning path
        function displayLearningPath(data){
            if(!data.learningPath) return;
            
            const section = document.getElementById('learningPathSection');
            const content = document.getElementById('learningPathContent');
            
            let html = `
                <div style="background:#e8eaf6;padding:15px;border-radius:8px;margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <strong>Progress:</strong> ${data.progress.completed}/${data.progress.total} topics (${data.progress.percentage}%)
                        </div>
                        <div>
                            <strong>Focus Area:</strong> ${data.performance.focusArea}
                        </div>
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px">
            `;
            
            for(const [subject,recommendations] of Object.entries(data.learningPath)){
                if(recommendations.length === 0) continue;
                
                html += `
                    <div style="background:#f9f9f9;padding:15px;border-radius:8px;border-left:4px solid #667eea">
                        <h3 style="color:#667eea;margin-bottom:10px;font-size:16px">${subject}</h3>
                `;
                
                recommendations.slice(0,2).forEach((rec,idx)=>{
                    const diffClass = rec.difficultyLabel === 'Easy' ? 'badge-easy' : 
                                     rec.difficultyLabel === 'Medium' ? 'badge-medium' : 'badge-hard';
                    
                    html += `
                        <div style="background:#fff;padding:10px;margin-bottom:8px;border-radius:5px;font-size:13px">
                            <div style="font-weight:600;margin-bottom:4px">${idx+1}. ${rec.topic}</div>
                            <div style="color:#666;font-size:12px;margin-bottom:4px">${rec.reason}</div>
                            <span class="badge ${diffClass}">${rec.difficultyLabel}</span>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            html += `</div>`;
            
            if(data.summary.recommendation){
                html += `
                    <div style="background:#fff3cd;padding:12px;border-radius:5px;margin-top:15px;font-size:14px">
                        üí° <strong>Tip:</strong> ${data.summary.recommendation}
                    </div>
                `;
            }
            
            content.innerHTML = html;
            section.style.display = 'block';
        }
        
        // Initialize
        loadQuizzes();
        loadLearningPath();
    </script>
</body>
</html>
